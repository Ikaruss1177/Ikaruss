<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Ikaruss Retrogaming Zone</title>
    <style>
        body { margin:0; background:#000; color:#FFD700; font-family:arial; }
        #header { display:flex; align-items:center; justify-content:center; padding:10px; }
        #header img { height:50px; }
        #header h1 { margin:0 15px; }
        #selector { text-align:center; padding:10px; }
        select { background:#111; color:#FFD700; padding:5px; font-size:16px; margin:5px; border:1px solid #FFD700; }
        button { background:#FFD700; color:#000; padding:8px 20px; font-size:16px; cursor:pointer; border:none; margin:5px; }
        #emulador { display:flex; justify-content:center; margin-top:10px; }
        #btnVolver { display:none; margin:20px auto; background:#00BFFF; color:white; }
    </style>
</head>
<body>
    <div id="header">
        <img src="Megaroad%20logo.png">
        <h1>Ikaruss Retrogaming Zone</h1>
        <img src="Megaroad%20logo.png">
    </div>
    <div id="menu">
        <div id="selector">
            <select id="consola">
                <option value="">Selecciona consola</option>
                <option value="nes">NES</option>
                <option value="snes">Super NES</option>
                <option value="gbc">Game Boy Color</option>
                <option value="wonderswan">Bandai WonderSwan</option>
                <option value="genesis">Sega Genesis</option>
                <option value="mame">MAME Arcade</option>
                <option value="psx">PlayStation</option>
            </select>
            <select id="juego">
                <option value="">Selecciona juego</option>
            </select>
            <button id="btnJugar">Jugar</button>
        </div>
    </div>
    <div id="emulador"></div>
    <button id="btnVolver">Volver al Menu</button>

    <script>
        const base = window.location.href.includes('discordsays.com') ? '/roms/' : 'https://ikaruss1177.github.io/Ikaruss/';
        const juegos = {
            nes: [
                { nombre: '42 Juegos en 1', archivo: base + '42-in-1.nes', core: 'nes' },
                { nombre: 'SDF Macross', archivo: base + 'Chou%20Jikuu%20Yousai%20-%20Macross%20(J).nes', core: 'nes' },
                { nombre: 'Saint Seiya vs Los Caballeros del Zodiaco', archivo: base + 'Saint%20Seiya%20-%20Ougon%20Densetsu%20(Spanish%20v1.0)(Juan).nes', core: 'nes' },
                { nombre: 'Saint Seiya vs Los Caballeros del Zodiaco 2', archivo: base + 'Saint%20Seiya%20-%20Ougon%20Densetsu%20Kanketsu%20Hen%20(English%20v1.01).nes', core: 'nes' }
            ],
            snes: [
                { nombre: 'Macross Scrambled Valkyrie', archivo: base + 'Choujikuu%20Yousai%20Macross%20-%20Scrambled%20Valkyrie%20(Japan).sfc', core: 'snes' }
            ],
            gbc: [
                { nombre: 'Macross 7: ¡Haz Vibrar la Galaxia!', archivo: base + 'Macross%207.gbc', core: 'gambatte' }
            ],
            wonderswan: [
                { nombre: 'Digimon Digital Monster', archivo: base + 'Digimon%20-%20Ver.%20WonderSwan%20(Asia).ws', core: 'ws' },
                { nombre: 'Macross: True Love Song', archivo: base + 'Macross%20-%20True%20Love%20Song%20(Japan).ws', core: 'ws' },
                { nombre: 'Sakura Card Captor - Las Cartas Clow', archivo: base + 'Cardcaptor%20Sakura%20-%20Sakura%20to%20Fushigi%20na%20Clow%20Card%20(Japan).ws', core: 'ws' },
                { nombre: 'SD Gundam: Emotional Jam', archivo: base + 'SD%20Gundam%20-%20Emotional%20Jam%20(Japan).ws', core: 'ws' }
            ],
            genesis: [
                { nombre: 'Dragon Ball Z:Leyendas de Poder', archivo: base + 'DBZ.SMD', core: 'segaMD' },
                { nombre: 'El Mundo Perdido - Jurassic Park', archivo: base + 'LOSTWRLD.SMD', core: 'segaMD' },
                { nombre: 'Heavy Unit Armored Robot', archivo: base + 'Heavy%20Unit(Japan).SMD', core: 'segaMD' },
                { nombre: 'Jurassic Park', archivo: base + 'JURASSIC.SMD', core: 'segaMD' },
                { nombre: 'Sailor Moon', archivo: base + 'SAILORM.SMD', core: 'segaMD' }
            ],
            mame: [
                { nombre: 'Macross II', archivo: base + 'macross2.zip', core: 'arcade' },
                { nombre: 'Macross Plus', archivo: base + 'macrossp.zip', core: 'arcade' },
                { nombre: 'SDF Macross: Do You Remember Love?', archivo: base + 'macross.zip', core: 'arcade' }
            ],
            psx: [
                { 
                    nombre: 'Macross: Do You Remember Love?', 
                    core: 'psx',
                    bios: 'https://ikaruss1177.github.io/Ikaruss/psx/SCPH1001.BIN',
                    partes: [
                        {
                            disco: 1,
                            archivos: [
                                'https://ikaruss1177.github.io/Ikaruss/psx/Macross%20-%20Do%20You%20Remember%20Love%20(Japan)%20(Disc%201)%20%5BSLPS-02005%5D.7z.001',
                                'https://ikaruss1177.github.io/Ikaruss/psx/Macross%20-%20Do%20You%20Remember%20Love%20(Japan)%20(Disc%201)%20%5BSLPS-02005%5D.7z.002',
                                'https://ikaruss1177.github.io/Ikaruss/psx/Macross%20-%20Do%20You%20Remember%20Love%20(Japan)%20(Disc%201)%20%5BSLPS-02005%5D.7z.003',
                                'https://ikaruss1177.github.io/Ikaruss/psx/Macross%20-%20Do%20You%20Remember%20Love%20(Japan)%20(Disc%201)%20%5BSLPS-02005%5D.7z.004',
                                'https://ikaruss1177.github.io/Ikaruss/psx/Macross%20-%20Do%20You%20Remember%20Love%20(Japan)%20(Disc%201)%20%5BSLPS-02005%5D.7z.005',
                                'https://ikaruss1177.github.io/Ikaruss/psx/Macross%20-%20Do%20You%20Remember%20Love%20(Japan)%20(Disc%201)%20%5BSLPS-02005%5D.7z.006'
                            ]
                        },
                        {
                            disco: 2,
                            archivos: [
                                'https://ikaruss1177.github.io/Ikaruss/psx/Macross%20-%20Do%20You%20Remember%20Love%20(Japan)%20(Disc%202)%20%5BSLPS-02006%5D.7z.001',
                                'https://ikaruss1177.github.io/Ikaruss/psx/Macross%20-%20Do%20You%20Remember%20Love%20(Japan)%20(Disc%202)%20%5BSLPS-02006%5D.7z.002',
                                'https://ikaruss1177.github.io/Ikaruss/psx/Macross%20-%20Do%20You%20Remember%20Love%20(Japan)%20(Disc%202)%20%5BSLPS-02006%5D.7z.003',
                                'https://ikaruss1177.github.io/Ikaruss/psx/Macross%20-%20Do%20You%20Remember%20Love%20(Japan)%20(Disc%202)%20%5BSLPS-02006%5D.7z.004',
                                'https://ikaruss1177.github.io/Ikaruss/psx/Macross%20-%20Do%20You%20Remember%20Love%20(Japan)%20(Disc%202)%20%5BSLPS-02006%5D.7z.005',
                                'https://ikaruss1177.github.io/Ikaruss/psx/Macross%20-%20Do%20You%20Remember%20Love%20(Japan)%20(Disc%202)%20%5BSLPS-02006%5D.7z.006',
                                'https://ikaruss1177.github.io/Ikaruss/psx/Macross%20-%20Do%20You%20Remember%20Love%20(Japan)%20(Disc%202)%20%5BSLPS-02006%5D.7z.007',
                                'https://ikaruss1177.github.io/Ikaruss/psx/Macross%20-%20Do%20You%20Remember%20Love%20(Japan)%20(Disc%202)%20%5BSLPS-02006%5D.7z.008',
                                'https://ikaruss1177.github.io/Ikaruss/psx/Macross%20-%20Do%20You%20Remember%20Love%20(Japan)%20(Disc%202)%20%5BSLPS-02006%5D.7z.009',
                                'https://ikaruss1177.github.io/Ikaruss/psx/Macross%20-%20Do%20You%20Remember%20Love%20(Japan)%20(Disc%202)%20%5BSLPS-02006%5D.7z.010'
                            ]
                        }
                    ]
                }
            ]
        };

        const params = new URLSearchParams(window.location.search);

        if (params.get('core') && params.get('rom')) {
            document.getElementById('header').style.display = 'none';
            document.getElementById('menu').style.display = 'none';
            document.getElementById('emulador').innerHTML = '<div style="width:640px;height:480px;"><div id="game"></div></div>';
            document.getElementById('btnVolver').style.display = 'block';

            window.EJS_player = '#game';
            window.EJS_core = params.get('core');
            const romParam = params.get('rom');
            try {
                const parsed = JSON.parse(romParam);
                window.EJS_gameUrl = Array.isArray(parsed) ? parsed[0] : parsed;
                if (Array.isArray(parsed) && parsed.length > 1) {
                    window.EJS_multidisk = parsed;
                }
            } catch(e) {
                window.EJS_gameUrl = romParam;
            }
            window.EJS_pathtodata = 'data/';
            if (params.get('bios')) {
                window.EJS_biosUrl = params.get('bios');
            }

            var script = document.createElement('script');
            script.src = 'data/loader.js';
            document.body.appendChild(script);
        }

        function actualizarJuegos() {
            const consola = document.getElementById('consola').value;
            const selectJuego = document.getElementById('juego');
            selectJuego.innerHTML = '<option value="">Selecciona juego</option>';
            if (consola && juegos[consola]) {
                juegos[consola].forEach((j, i) => {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = j.nombre;
                    selectJuego.appendChild(option);
                });
            }
        }

        async function ensamblarDiscos(juego) {
            document.getElementById('header').style.display = 'none';
            document.getElementById('menu').style.display = 'none';
            document.getElementById('emulador').innerHTML = `
                <div style="text-align:center;padding:40px;">
                    <div id="progreso" style="color:#FFD700;font-size:18px;">Descargando juego... por favor esperá</div>
                    <div style="margin-top:20px;background:#111;border:1px solid #FFD700;width:400px;margin:20px auto;">
                        <div id="barra" style="background:#FFD700;height:20px;width:0%;transition:width 0.3s;"></div>
                    </div>
                    <div id="detalle" style="color:#888;font-size:14px;"></div>
                </div>`;
            document.getElementById('btnVolver').style.display = 'block';

            const discos = [];

            for (let d = 0; d < juego.partes.length; d++) {
                const disco = juego.partes[d];
                const partes = [];
                for (let i = 0; i < disco.archivos.length; i++) {
                    const url = disco.archivos[i];
                    document.getElementById('progreso').textContent = `Descargando Disco ${disco.disco} - parte ${i+1} de ${disco.archivos.length}...`;
                    document.getElementById('barra').style.width = ((d * disco.archivos.length + i) / (juego.partes.reduce((a,b) => a + b.archivos.length, 0))) * 100 + '%';
                    const resp = await fetch(url);
                    const buf = await resp.arrayBuffer();
                    partes.push(new Uint8Array(buf));
                }
                // Unir todas las partes
                const totalSize = partes.reduce((a, b) => a + b.length, 0);
                const joined = new Uint8Array(totalSize);
                let offset = 0;
                for (const p of partes) { joined.set(p, offset); offset += p.length; }
                discos.push(joined);
            }

            document.getElementById('progreso').textContent = 'Descomprimiendo... esto puede tardar un momento';

            // Descomprimir con 7z-wasm
            const { createExtractorFromData } = await import('https://unpkg.com/node-7z-archive@1.0.2/dist/browser/index.js').catch(() => null);
            
            if (!createExtractorFromData) {
                document.getElementById('progreso').textContent = 'Error al cargar descompresor. Intentando método alternativo...';
                // Intentar con archivos CHD directamente si están disponibles
                return;
            }

            const urls = [];
            for (let d = 0; d < discos.length; d++) {
                const extractor = await createExtractorFromData({ data: discos[d] });
                const files = [...extractor.extract().files];
                const file = files[0];
                const blob = new Blob([file.extraction], { type: 'application/octet-stream' });
                urls.push(URL.createObjectURL(blob));
            }

            document.getElementById('emulador').innerHTML = '<div style="width:640px;height:480px;"><div id="game"></div></div>';
            window.EJS_player = '#game';
            window.EJS_core = juego.core;
            window.EJS_gameUrl = urls;
            window.EJS_pathtodata = 'data/';
            if (juego.bios) window.EJS_biosUrl = juego.bios;
            var script = document.createElement('script');
            script.src = 'data/loader.js';
            document.body.appendChild(script);
        }

        function cargarJuego() {
            const consola = document.getElementById('consola').value;
            const idx = document.getElementById('juego').value;
            if (!consola || idx === '') return;
            const juego = juegos[consola][idx];

            if (juego.partes) {
                ensamblarDiscos(juego);
            } else if (Array.isArray(juego.archivo)) {
                document.getElementById('header').style.display = 'none';
                document.getElementById('menu').style.display = 'none';
                document.getElementById('emulador').innerHTML = '<div style="width:640px;height:480px;"><div id="game"></div></div>';
                document.getElementById('btnVolver').style.display = 'block';
                window.EJS_player = '#game';
                window.EJS_core = juego.core;
                window.EJS_gameUrl = juego.archivo;
                window.EJS_pathtodata = 'data/';
                if (juego.bios) window.EJS_biosUrl = juego.bios;
                var script = document.createElement('script');
                script.src = 'data/loader.js';
                document.body.appendChild(script);
            } else {
                let url = '?core=' + juego.core + '&rom=' + encodeURIComponent(juego.archivo);
                if (juego.bios) url += '&bios=' + encodeURIComponent(juego.bios);
                window.location.href = url;
            }
        }

        document.getElementById('consola').addEventListener('change', actualizarJuegos);
        document.getElementById('btnJugar').addEventListener('click', cargarJuego);
        document.getElementById('btnVolver').addEventListener('click', () => {
            window.location.href = window.location.pathname;
        });
    </script>
</body>
</html>
